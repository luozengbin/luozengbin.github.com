#+TITLE: [検証]Minor GCのPremature Promotion問題
#+DATE: 2014-11-24
#+SETUPFILE: ~/.emacs.d/blogs/octopress/setupfile.org
#+JEKYLL_LAYOUT: post
#+JEKYLL_CATEGORIES: java
#+JEKYLL_TAGS: GC
#+JEKYLL_COMMENTS: true
#+JEKYLL_PUBLISHED: true

ページ
P59

* Premature Promotionについて
Minor GCでTo Survivorの空間が足りない場合、Survivorに格納できないオブジェクトがOld領域
に移動される。こははPremature Promotion問題と言います。

Minor GCは以下のように行われる。Eden領域、From領域に生き残るオブジェクトが To領域に移
動される。この時にTo領域に格納しきれないオブジェクトがOldに追い出される。Old領域に短
命のオブジェクトが格納されFullGCを引き起こす可能性がある。

#+begin_example
+-------------------------+
| Eden                    |
+------------------+------+
                   |
+----------+ +-----+------+
| From     +-> To         |
+----------+ +------------+

+-------------------------+
|Tenure(Old)              |
+-------------------------+
#+end_example

* TODO: GCログでPremature Promotion問題を観測する

* Promotion Failureについて
Minor GCでOld領域が満タンになってOld領域へのオブジェクト移動ができなるなった時は
Promotion Failureと言います。


{{{more}}}
* SolarisStudio12.4インストール記録
Docker Hub から Oracle Linux 6を適当にpullして新規コンテナーを起動します。
#+begin_example
$ sudo systemctl start docker
$ docker pull unbc/oraclelinux6

★新規コンテナーtuning_01を起動します
$ docker run  -it -name tuning_01 unbc/oraclelinux6 /bin/bash

★コンテナーのIPを確認します
bash-4.1# ip addr show
#+end_example

コンテナーにパッケージをインストールします。
#+begin_example
bash-4.1# yum install glibc glibc-devel elfutils-libelf-devel  zlib libstdc++ libgcc openssl libXtst libXtst-devel ld-linux.so.2 wgeta
bash-4.1# wget --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/7u72-b14/jdk-7u72-linux-x64.rpm"
bash-4.1# rpm -ivh jdk-7u72-linux-x64.rpm
#+end_example

[[http://www.oracle.com/technetwork/server-storage/solarisstudio/downloads/index.html][Oracle Solaris Studio 12.4ダウンロードページ]] からrpmインストールファイルをダウンロー
ドし、コンテナーのファイルシステムに格納します。
#+begin_example
$ aunpack SolarisStudio12.4-linux-x86-rpm.tar.bz2
SolarisStudio12.4-linux-x86-rpm
SolarisStudio12.4-linux-x86-rpm/LEGAL
SolarisStudio12.4-linux-x86-rpm/LEGAL/Copyright.OSS12.4_zh_CN.html
SolarisStudio12.4-linux-x86-rpm/LEGAL/Copyright.OSS12.4.html
SolarisStudio12.4-linux-x86-rpm/LEGAL/Copyright.OSS12.4_ja.html
SolarisStudio12.4-linux-x86-rpm/LEGAL/ProductName
SolarisStudio12.4-linux-x86-rpm/OSS12.4_README-pkg.txt
SolarisStudio12.4-linux-x86-rpm/OSS12.4_README-pkgs-ja.html
SolarisStudio12.4-linux-x86-rpm/solarisstudio.sh
SolarisStudio12.4-linux-x86-rpm/OSS12.4_README-pkgs-zh_CN.html
SolarisStudio12.4-linux-x86-rpm.tar.bz2: extracted to `SolarisStudio12.4-linux-x86-rpm'

$ docker inspect -f   '{{.Id}}' tuning_01
6f6e1d050902cd43649e9bf2e1a274bda9050c07a320a85fe3f8344fd9a62f83

$ sudo mv SolarisStudio12.4-linux-x86-rpm/ /var/lib/docker/devicemapper/mnt/6f6e1d050902cd43649e9bf2e1a274bda9050c07a320a85fe3f8344fd9a62f83/rootfs/root

★コンテナーに潜ってインストールファイルの所有者を変更する。
$ docker exec -it tuning_01 bash
bash-4.1# chown -R root:root /root/SolarisStudio12.4-linux-x86-rpm/
#+end_example

GUIでインストールするためにホストにてXクライアントの許可設定を実施します。
#+begin_example
$ sudo netstat -nutpl | grep 6000
tcp        0      0 0.0.0.0:6000            0.0.0.0:*               LISTEN      716/Xorg.bin

$ firewall-cmd --add-rich-rule='rule family="ipv4" source address="172.17.0.0/16" port port="6000" protocol="tcp" accept' --zone=public

★コンテナーのIPに
$ xhost +172.17.0.2
#+end_example


#+begin_example
$ docker exec -it tuning_01 bash
bash-4.1# cd /root/SolarisStudio12.4-linux-x86-rpm/
bash-4.1# ls -al
total 489532
drwxr-xr-x 3 root root      4096 Oct 22 01:03 .
dr-xr-x--- 4 root root      4096 Jan  4 10:08 ..
drwxr-xr-x 2 root root      4096 Oct 21 20:46 LEGAL
-r--r--r-- 1 root root      3422 Oct 21 20:47 OSS12.4_README-pkg.txt
-r--r--r-- 1 root root      4834 Oct 21 20:47 OSS12.4_README-pkgs-ja.html
-r--r--r-- 1 root root      3450 Oct 21 20:47 OSS12.4_README-pkgs-zh_CN.html
-rwxr-xr-x 1 root root 501246976 Oct 21 20:48 solarisstudio.sh

bash-4.1# export DISPLAY=172.17.42.1:0.0

bash-4.1# ./solarisstudio.sh 
Configuring the installer...
Searching for JVM on the system...
Extracting installation data (can take a while, please wait)...
Running the installer wizard...

#+end_example

インストーラー実行中で次のNPEエラーが出て失敗しました。

#+begin_example
cat ~/.nbi/log/20150104103234.log
......
[2015-01-04 10:34:08.965]:     Start installation of Support Files(support-files/12.4.0.0.0)
[2015-01-04 10:34:08.970]:         ... extracting files from the data archives
[2015-01-04 10:34:08.978]:         deleting file: /tmp/nbi-4380478504021798468.tmp
[2015-01-04 10:34:08.979]:         extracting /tmp/studio-legal.rpm
[2015-01-04 10:34:08.979]:         setting permissions 664 on /tmp/studio-legal.rpm
[2015-01-04 10:34:08.980]:         deleting file: /tmp/nbi-6637943706291849924.tmp/data,1.jar.0
[2015-01-04 10:34:08.984]:         deleting file: /tmp/nbi-1255821959469639399.tmp
[2015-01-04 10:34:08.984]:         extracting /tmp/studio-common.rpm
[2015-01-04 10:34:08.988]:         setting permissions 664 on /tmp/studio-common.rpm
[2015-01-04 10:34:08.989]:         deleting file: /tmp/nbi-6637943706291849924.tmp/data,2.jar
[2015-01-04 10:34:08.989]:         ... saving legal artifacts if required
[2015-01-04 10:34:08.989]:         ... running installation logic
[2015-01-04 10:34:08.989]:         entering -- org.netbeans.installer.product.components.Product.install():374
[2015-01-04 10:34:08.989]:         Installing native package...
[2015-01-04 10:34:08.992]:             java.lang.NullPointerException
[2015-01-04 10:34:08.992]:              at org.netbeans.installer.product.components.NativeClusterConfigurationLogic.getSPROsslnkInstalled(NativeClusterConfigurationLogic.java:110)
[2015-01-04 10:34:08.992]:              at org.netbeans.installer.product.components.NativeClusterConfigurationLogic.install(NativeClusterConfigurationLogic.java:136)
[2015-01-04 10:34:08.992]:              at org.netbeans.installer.product.components.Product.install(Product.java:374)
[2015-01-04 10:34:08.992]:              at org.netbeans.installer.wizard.components.actions.sunstudio.InstallAction.execute(InstallAction.java:168)
[2015-01-04 10:34:08.992]:              at org.netbeans.installer.wizard.components.WizardAction$1.run(WizardAction.java:120)
[2015-01-04 10:34:08.999]:             ... also rollbacking Oracle Solaris Studio(ss-base/12.4.0.0.0)

#+end_example

結局、rpm形式を利用したインストールを諦めて、tar形式を利用することになりました。

#+begin_example
bash-4.1# cd /opt/solarisstudio12.4/
bash-4.1# pwd
/opt/solarisstudio12.4
bash-4.1# ls
LEGAL  OIC  READMEs  bin  include  lib	man  prod  share
bash-4.1# ls -al
total 40
drwxr-xr-x 10 root root 4096 Oct 21 17:15 .
drwxr-xr-x  3 root root 4096 Jan  4 10:47 ..
drwxr-xr-x  2 root root 4096 Sep  4 17:16 LEGAL
drwxr-xr-x  6 root root 4096 Sep 19 16:41 OIC
drwxr-xr-x  7 root root 4096 Oct  2 21:13 READMEs
drwxr-xr-x  3 root root 4096 Oct 21 17:14 bin
drwxr-xr-x  4 root root 4096 Oct 21 17:14 include
drwxr-xr-x 15 root root 4096 Oct  2 21:15 lib
lrwxrwxrwx  1 root root    9 Oct 21 21:10 man -> share/man
drwxr-xr-x  3 root root 4096 Oct 21 17:13 prod
drwxr-xr-x  3 root root 4096 Oct  2 21:15 share

bash-4.1# export PATH=/opt/solarisstudio12.4/bin/:$PATH
bash-4.1# export MANPATH=/opt/solarisstudio12.4/man/:$MANPATH
bash-4.1# /opt/solarisstudio12.4/bin/analyzer
#+end_example


* 参考
- [[https://community.oracle.com/thread/2428249?tstart%3D0][Installation of Solaris Studio 12.3 crashes on Mandriva 2010.2 Linux distro]]

