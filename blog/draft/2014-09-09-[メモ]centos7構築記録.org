#+TITLE: [メモ]CentOS7構築記録
#+DATE: 2014-09-09
#+SETUPFILE: ~/.emacs.d/blogs/octopress/setupfile.org
#+JEKYLL_LAYOUT: post
#+JEKYLL_CATEGORIES: linux
#+JEKYLL_TAGS: centos
#+JEKYLL_COMMENTS: true
#+JEKYLL_PUBLISHED: true

{{{more}}}

* ハード構成
* インストール概要
- NetInstall方式
- GnomeDesktop
- パーティションはお任せモード
- 
* 不要なサービスの停止
** ディバイス存在しないもの
#+begin_example
systemctl disable bluetooth.service
systemctl disable fprintd.service
systemctl disable ModemManager.service
systemctl disable rngd.service
#+end_example

** カーネルやドライバー系
#+begin_example
systemctl disable microcode.service  ★CPU firmware update
systemctl disable multipathd         ★マルチパスI/Oのサポート
#+end_example
[[https://wiki.archlinux.org/index.php/microcode][microcode]]
[[https://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/5/html/DM_Multipath/][DM_Multipath]]

** Systemd readahead (性能改善先読み機能)
#+begin_example
systemctl disable systemd-readahead-collect.service ★Collect Read-Ahead Data
systemctl disable systemd-readahead-replay.service  ★Replay Read-Ahead Data
systemctl disable systemd-readahead-drop.service    ★Drop Read-Ahead Data
#+end_example
[[https://wiki.archlinux.org/index.php/Improve_boot_performance#Readahead][Systemd Readahead]]

** 仮想化関係のもの
#+begin_example
systemctl disable libvirtd.service
systemctl disable spice-vdagentd
systemctl disable vmtoolsd.service
systemctl disable hypervkvpd.service
systemctl disable hypervvssd.service
systemctl disable libstoragemgmt.service
systemctl disable ksm.service        ★Kernel Samepage Merging
systemctl disable ksmtuned.service   ★Kernel Samepage Merging (KSM) Tuning Daemon
#+end_example
[[http://www.slideshare.net/moriwaka/libstoragemgmt-14611142][libstoragemgmtっ何？]]
[[https://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/6/html/Virtualization_Administration_Guide/chap-KSM.html][仮想化管理ガイド 第7章 KSM]]

** IBM Power RAID adapter関係するもの
#+begin_example
systemctl disable iprdump.service   ★IBM Power RAID adapter dump utility
systemctl disable iprinit.service   ★IBM Power RAID adapter/device initialization utility
systemctl disable iprupdate.service ★IBM Power RAID adapter/device microcode update utility
#+end_example

#+begin_example
[akira@localhost /]$ sudo systemctl disable iprdump.service
iprdump.service is not a native service, redirecting to /sbin/chkconfig.
Executing /sbin/chkconfig iprdump off
[akira@localhost /]$
#+end_example

#+begin_example
[akira@localhost /]$ chkconfig --list

注記: この出力は SysV サービスのみであり、ネイティブな systemd のサービスは含まれていません。
      systemd services. SysV 設定のデータはネイティブな systemd の設定によって上書きされます。
      systemd サービスを一覧表示するには 'systemctl list-unit-files' を使用してください。
      特定のターゲットにおいて有効化されているサービスを確認するには、
      'systemctl list-dependencies [target]' 。

iprdump        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
iprinit        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
iprupdate      	0:off	1:off	2:on	3:on	4:on	5:on	6:off
netconsole     	0:off	1:off	2:off	3:off	4:off	5:off	6:off
network        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
[akira@localhost /]$ 
#+end_example

** iscsi関係
#+begin_example
systemctl disable iscsid.socket
systemctl disable iscsiuio.socket
#+end_example
** 自動バグ報告ツール (ABRT)
#+begin_example
systemctl disable abrt-ccpp.service
systemctl disable abrt-oops.service
systemctl disable abrt-xorg.service
systemctl disable abrtd.service
#+end_example

** 自動チューリング
#+begin_example
systemctl disable tuned.service
#+end_example

** NFS関係

* ブート時の表示
方式２つ
- /etc/default/grub + grub2-mkconfig
- /boot/efi/EFI/centos/grub.cfgを直接いじる

とりあえず =/boot/efi/EFI/centos/grub.cfg= から =rhgb= と =quiet= を外す。

#+begin_example
# sed -i s/quiet//g grub.cfg
#+end_example

* パーティション整理
* パッケージのインストール
#+begin_example
net-tools
mlocate
rpcbind
emacs
httpd httpd-devel httpd-manual httpd-tools mod_dav_svn mod_ldap apr-util apr
nfs-utils
#+end_example

#+begin_example
sudo systemctl enable NetworkManager-wait-online.service
#+end_example

* ホスト名の設定
=/etc/hostname=
#+begin_example
nassrv.myhome.local
#+end_example

=/etc/hosts=
#+begin_example
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         nasrv.myhome.local nasrv localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.100.5 nasrv.myhome.local nasrv
#+end_example

* IPv6を停止する
=/etc/defaukt/grub=
#+begin_example
GRUB_CMDLINE_LINUX="...... ipv6.disable=1"
#+end_example
grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg

RCPにおける ipv6 の無効化
=/etc/netconfig=
#+begin_example
[akira@nassrv ~]$ cat /etc/netconfig
#
# The network configuration file. This file is currently only used in
# conjunction with the TI-RPC code in the libtirpc library.
#
# Entries consist of:
#
#       <network_id> <semantics> <flags> <protofamily> <protoname> \
#               <device> <nametoaddr_libs>
#
# The <device> and <nametoaddr_libs> fields are always empty in this
# implementation.
#
udp        tpi_clts      v     inet     udp     -       -
tcp        tpi_cots_ord  v     inet     tcp     -       -
★IPv6の無効化
##udp6       tpi_clts      v     inet6    udp     -       -
##tcp6       tpi_cots_ord  v     inet6    tcp     -       -
rawip      tpi_raw       -     inet      -      -       -
local      tpi_cots_ord  -     loopback  -      -       -
unix       tpi_cots_ord  -     loopback  -      -       -

#+end_example

* SELinuxの無効化
=/etc/selinux/config= ファイルに =SELINUX= 項目の値を =disabled= へ変更する。
サーバ再起動する。

* 静的IPの指定
=nmtui= テキスト対話式コマンドで設定を行うと、設定の内容が
=/etc/sysconfig/network-scripts/ifcfg-enp1s0= に反映される。

#+begin_example
[akira@nassrv ~]$ cat /etc/sysconfig/network-scripts/ifcfg-enp1s0 
TYPE="Ethernet"
BOOTPROTO=none
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT=no
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_PEERDNS="yes"
IPV6_PEERROUTES="yes"
IPV6_FAILURE_FATAL="no"
NAME="enp1s0"
UUID="7146129d-349f-4a2d-8a7f-b1f7d728aeca"
ONBOOT="yes"
HWADDR=74:27:EA:D1:C7:51
IPADDR0=192.168.100.5
PREFIX0=24
GATEWAY0=192.168.100.1
DNS1=192.168.100.1
DNS2=129.250.35.250
DNS3=129.250.35.251
DOMAIN=myhome.local
[akira@nassrv ~]$ 
#+end_example

また、 =nmcli= コマンドでネットワークの詳細な設定状況を確認することができる。
#+begin_example
[akira@nassrv ~]$ sudo nmcli connection show enp1s0 
connection.id:                          enp1s0
connection.uuid:                        7146129d-349f-4a2d-8a7f-b1f7d728aeca
connection.interface-name:              --
connection.type:                        802-3-ethernet
connection.autoconnect:                 yes
connection.timestamp:                   1410665179
connection.read-only:                   no
connection.permissions:                 
connection.zone:                        --
connection.master:                      --
connection.slave-type:                  --
connection.secondaries:                 
connection.gateway-ping-timeout:        0
802-3-ethernet.port:                    --
802-3-ethernet.speed:                   0
802-3-ethernet.duplex:                  --
802-3-ethernet.auto-negotiate:          yes
802-3-ethernet.mac-address:             74:27:EA:D1:C7:51
802-3-ethernet.cloned-mac-address:      --
802-3-ethernet.mac-address-blacklist:   
802-3-ethernet.mtu:                     自動
802-3-ethernet.s390-subchannels:        
802-3-ethernet.s390-nettype:            --
802-3-ethernet.s390-options:            
ipv4.method:                            manual
ipv4.dns:                               192.168.100.1, 129.250.35.250, 129.250.35.251
ipv4.dns-search:                        myhome.local
ipv4.addresses:                         { ip = 192.168.100.5/32, gw = 192.168.100.1 }
ipv4.routes:                            
ipv4.ignore-auto-routes:                no
ipv4.ignore-auto-dns:                   no
ipv4.dhcp-client-id:                    --
ipv4.dhcp-send-hostname:                yes
ipv4.dhcp-hostname:                     --
ipv4.never-default:                     no
ipv4.may-fail:                          yes
ipv6.method:                            ignore
ipv6.dns:                               
ipv6.dns-search:                        
ipv6.addresses:                         
ipv6.routes:                            
ipv6.ignore-auto-routes:                no
ipv6.ignore-auto-dns:                   no
ipv6.never-default:                     no
ipv6.may-fail:                          yes
ipv6.ip6-privacy:                       -1 (不明)
ipv6.dhcp-hostname:                     --
GENERAL.名前:                           enp1s0
GENERAL.UUID:                           7146129d-349f-4a2d-8a7f-b1f7d728aeca
GENERAL.デバイス:                       enp1s0
GENERAL.状態:                           アクティベート済み
GENERAL.デフォルト:                     はい
GENERAL.デフォルト6:                    いいえ
GENERAL.VPN:                            いいえ
GENERAL.ゾーン:                         --
GENERAL.DBUS パス:                      /org/freedesktop/NetworkManager/ActiveConnection/0
GENERAL.CON パス:                       /org/freedesktop/NetworkManager/Settings/0
GENERAL.スペックオブジェクト:           --
GENERAL.マスターパス:                   --
IP4.アドレス[1]:                        ip = 192.168.100.5/32, gw = 192.168.100.1
IP4.DNS[1]:                             192.168.100.1
IP4.DNS[2]:                             129.250.35.250
IP4.DNS[3]:                             129.250.35.251
[akira@nassrv ~]$ 
#+end_example

* 起動ログから問題の排除
起動ログを分析し、問題箇所を見つけて排除する。

#+begin_example
 9月 14 12:21:17 nassrv.myhome.local systemd-fsck[286]: fsck: error 2 (No such file or directory) while executing fsck.ext2 for /dev/mapper/centos-root
 9月 14 12:21:17 nassrv.myhome.local systemd-fsck[286]: fsck failed with error code 8.
 9月 14 12:21:17 nassrv.myhome.local systemd-fsck[286]: Ignoring error.
 9月 14 12:21:17 nassrv.myhome.local systemd[1]: Started File System Check on /dev/mapper/centos-root.
#+end_example


** 問題１
#+begin_example
 9月 14 12:21:17 nassrv.myhome.local kernel: radeon 0000:00:01.0: fb0: radeondrmfb frame buffer device
 9月 14 12:21:17 nassrv.myhome.local kernel: radeon 0000:00:01.0: registered panic notifier
 9月 14 12:21:17 nassrv.myhome.local kernel: [drm:radeon_acpi_init] *ERROR* Cannot find a backlight controller  ★ここ
#+end_example

http://christina04.blog.fc2.com/blog-entry-162.html

** 問題2

#+begin_example
 9月 14 12:21:19 nassrv.myhome.local auditd[681]: Init complete, auditd 2.3.3 listening for events (startup state enable)
 9月 14 12:21:19 nassrv.myhome.local audispd[693]: priority_boost_parser called with: 4
 9月 14 12:21:19 nassrv.myhome.local audispd[693]: max_restarts_parser called with: 10
 9月 14 12:21:19 nassrv.myhome.local audispd[693]: No plugins found, exiting       ★ここ
#+end_example

回避方法
#+begin_example 
yum install audispd-plugins
#+end_example


* EPELの設定
http://www.websec-room.com/2014/01/15/1535
#+begin_example
$ sudo rpm -Uvh http://mirror.pnl.gov/epel/7/x86_64/e/epel-release-7-2.noarch.rpm
#+end_example

/etc/yum.repos.d/epel.repo
enabled=0


yum -y install yum-plugin-priorities
http://centossrv.com/rpmforge.shtml

wget http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.3-1.el7.rf.x86_64.rpm
yum  update rpmforge-release

* 参考情報
http://www.unix-power.net/centos7/systemctl.html
http://aikotobaha.blogspot.jp/2010/02/redhatiodm-multipath.html


