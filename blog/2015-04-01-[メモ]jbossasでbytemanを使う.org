#+TITLE: [メモ]JBoss ASでBytemanを使う
#+DATE: 2015-04-01
#+SETUPFILE: ~/.emacs.d/blogs/octopress/setupfile.org
#+JEKYLL_LAYOUT: post
#+JEKYLL_CATEGORIES: java
#+JEKYLL_TAGS: JBossAS Byteman
#+JEKYLL_COMMENTS: true
#+JEKYLL_PUBLISHED: true

ミドルウェアの内部動作をトレースするためによく使うので手順を残しておきます。

{{{more}}}

* 前提
- JBossAS 7系

* インストール
#+begin_example
$ wget http://downloads.jboss.org/byteman/2.2.1/byteman-download-2.2.1-bin.zip
$ unzip byteman-download-2.2.1-bin.zip
#+end_example

* JBossASプロセスへのアタッチ
#+begin_example
$ export BYTEMAN_HOME=`pwd`/byteman-download-2.2.1
$ export JAVA_HOME=/usr/lib/jvm/java-1.7.0-openjdk-1.7.0.65.x86_64
$ JBOSS_PID=`ps -ef | grep [j]boss-modules.jar | awk '{print $2}'`
$ ${BYTEMAN_HOME}/bin/bminstall.sh -b ${JBOSS_PID}
#+end_example

* トレース用スクリプトの作成
JBossASサーバソケット受信バッファーサイズを調べるスクリプト
=trace_socket_receive_buffer_size.btm= を作成する

#+begin_example
RULE trace http ReceiveBufferSize
CLASS org.apache.tomcat.util.net.JIoEndpoint
METHOD processSocket
AT ENTRY
BIND socket = $1
IF TRUE
DO
  traceln("socket.getReceiveBufferSize() = " + socket.getReceiveBufferSize()), traceStack()
ENDRULE
#+end_example

* スクリプトの実行
#+begin_example
$ ${BYTEMAN_HOME}/bin/bmsubmit.sh trace_socket_receive_buffer_size.btm
#+end_example

* 参考
- [[https://developer.jboss.org/wiki/ABytemanTutorial#how_do_i_run_jboss_as_with_byteman][A Byteman Tutorial]]
- [[http://nekop.hatenablog.com/entry/20101220/1292825812][BytemanによるJava黒魔術]]
- [[http://d.hatena.ne.jp/Kazuhira/20131022/1382455739][バイトコード操作ツール、Bytemanを試す]]
